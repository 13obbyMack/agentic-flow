# AgentDB v1.5.8 - Hooks Integration CLI Commands

## Summary

Version 1.5.8 adds four new CLI commands specifically designed for hooks integration and automation workflows. These commands enable seamless integration with Claude Code hooks for experience capture, pattern learning, and memory optimization.

## New CLI Commands

### 1. `agentdb query`
**Purpose**: Semantic search across stored episodes and patterns

**Usage**:
```bash
agentdb query --domain <domain> --query <query> --k <k> --min-confidence <conf> --format json
```

**Parameters**:
- `--domain` - Domain filter (e.g., "successful-edits", "code-edits")
- `--query` - Search query text
- `--k` - Number of results to return (default: 5)
- `--min-confidence` - Minimum confidence/reward threshold (default: 0.0)
- `--format` - Output format: "json" or "text" (default: "json")

**Example**:
```bash
agentdb query --domain "successful-edits" --query "file:utils.ts" --k 5 --min-confidence 0.8 --format json
```

**Returns**: JSON array of relevant episodes with similarity scores

---

### 2. `agentdb store-pattern`
**Purpose**: Store learned patterns for future retrieval

**Usage**:
```bash
agentdb store-pattern --type <type> --domain <domain> --pattern <json> --confidence <conf>
```

**Parameters**:
- `--type` - Pattern type (e.g., "experience", "insight", "strategy")
- `--domain` - Domain classification (e.g., "code-edits", "bug-fixes")
- `--pattern` - JSON object containing pattern data
- `--confidence` - Confidence score 0.0-1.0 (default: 0.5)

**Example**:
```bash
agentdb store-pattern --type "experience" --domain "code-edits" \
  --pattern '{"file":"utils.ts","success":true,"approach":"refactoring"}' \
  --confidence 0.9
```

**Returns**: JSON with success status and session ID

---

### 3. `agentdb train`
**Purpose**: Trigger pattern learning and skill consolidation

**Usage**:
```bash
agentdb train --domain <domain> --epochs <n> --batch-size <n>
```

**Parameters**:
- `--domain` - Domain to train on (optional, defaults to all)
- `--epochs` - Number of training epochs (default: 10)
- `--batch-size` - Batch size for training (default: 32)

**Example**:
```bash
agentdb train --domain "code-edits" --epochs 10 --batch-size 32
```

**What it does**:
1. Runs learner to discover causal patterns (minAttempts=3, minSuccessRate=0.6, minConfidence=0.7)
2. Consolidates skills from successful episodes (minAttempts=3, minReward=0.7, timeWindow=7days)

**Returns**: JSON with success status and message

---

### 4. `agentdb optimize-memory`
**Purpose**: Memory consolidation, compression, and cleanup

**Usage**:
```bash
agentdb optimize-memory --compress <bool> --consolidate-patterns <bool>
```

**Parameters**:
- `--compress` - Enable episode compression/pruning (default: true)
- `--consolidate-patterns` - Enable pattern consolidation into skills (default: true)

**Example**:
```bash
agentdb optimize-memory --compress true --consolidate-patterns true
```

**What it does**:
1. **Compress**: Prunes old/low-quality episodes (maxAge=90days, minReward=0.3)
2. **Consolidate**: Creates skills from successful patterns (minAttempts=3, minReward=0.7)
3. **Prune Skills**: Removes underperforming skills (minUses=3, minSuccessRate=0.4, maxAge=60days)
4. **Prune Causal Edges**: Removes low-confidence causal relationships (minConfidence=0.5, minUplift=0.05, maxAge=90days)

**Returns**: JSON with success status and message

---

## Hooks Integration Example

### Pre-Edit Hook (Experience Capture)
```bash
#!/bin/bash
FILE="$1"
EDIT_CONTEXT="$(agentdb query --domain 'successful-edits' --query "file:$FILE" --k 5 --min-confidence 0.8 --format json)"

# Use context to inform edit strategy
echo "Previous successful edits for $FILE: $EDIT_CONTEXT"
```

### Post-Edit Hook (Pattern Storage)
```bash
#!/bin/bash
FILE="$1"
SUCCESS="$2"  # true/false

if [ "$SUCCESS" = "true" ]; then
  agentdb store-pattern \
    --type "experience" \
    --domain "code-edits" \
    --pattern "{\"file\":\"$FILE\",\"success\":true,\"timestamp\":$(date +%s)}" \
    --confidence 0.9
fi
```

### Session-End Hook (Training)
```bash
#!/bin/bash
# Train on today's experiences
agentdb train --domain "code-edits" --epochs 10 --batch-size 32

# Optimize memory
agentdb optimize-memory --compress true --consolidate-patterns true
```

---

## Technical Details

### Command Handler Implementation

All four commands are implemented in `/packages/agentdb/src/cli/agentdb-cli.ts`:

1. **handleQueryCommand** (line 1028): Uses `reflexionRetrieveJson()` for JSON output
2. **handleStorePatternCommand** (line 1091): Stores patterns as reflexion episodes
3. **handleTrainCommand** (line 1141): Runs learner + skill consolidation
4. **handleOptimizeMemoryCommand** (line 1178): Multi-stage memory optimization

### New Public Method

Added `reflexionRetrieveJson()` method (line 474) to AgentDBCLI class:
- Returns episode data as JSON array instead of printing to console
- Enables programmatic access to search results

---

## Testing

### Test Commands
```bash
# Initialize test database
agentdb init test-db.db

# Store a pattern
agentdb store-pattern --type "experience" --domain "test" \
  --pattern '{"test":true}' --confidence 0.9

# Query patterns
agentdb query --domain "test" --query "test" --k 5 --format json

# Train
agentdb train --domain "test" --epochs 1 --batch-size 10

# Optimize
agentdb optimize-memory --compress true --consolidate-patterns true
```

---

## Breaking Changes

None. All changes are additive.

---

## Migration from Previous Versions

No migration needed. Existing commands and APIs remain unchanged.

---

## Version History

- **v1.5.8**: Added hooks integration CLI commands (query, store-pattern, train, optimize-memory)
- **v1.5.7**: Added CLI command routing (not published)
- **v1.5.6**: Added learning_sessions table
- **v1.5.5**: Added learning_experiences table
- **v1.5.4**: Added transaction support for sql.js
- **v1.5.3**: Transaction API improvements
- **v1.5.2**: Safe table counting for stats
- **v1.5.1**: ES module __dirname fix
- **v1.5.0**: Schema initialization improvements

---

## References

- Main CLI: `/packages/agentdb/src/cli/agentdb-cli.ts`
- Package: `/packages/agentdb/package.json`
- Schemas: `/packages/agentdb/src/schemas/frontier-schema.sql`
