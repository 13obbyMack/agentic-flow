# AgentDB v1.6.0 - Quick Start Guide

## New Features Overview

AgentDB v1.6.0 introduces powerful advanced features for intelligent memory retrieval and data management:

1. **MMR Diversity Ranking** - Get diverse, non-redundant results
2. **Context Synthesis** - Automatic pattern recognition and insights
3. **Metadata Filtering** - MongoDB-style query filtering
4. **Compression Support** - Efficient data export/import

## Installation

```bash
npm install agentdb@1.6.0
```

## Quick Examples

### 1. MMR Diversity Ranking

Get diverse results that balance relevance and variety:

```bash
# Standard similarity search (may return similar duplicates)
agentdb vector-search db.db "[0.1,0.2,0.3]" -k 10

# With diversity ranking (ensures varied results)
agentdb vector-search db.db "[0.1,0.2,0.3]" -k 10 --mmr 0.5
```

**JavaScript API**:
```typescript
import { MMRDiversityRanker } from 'agentdb/controllers';

const diverse = MMRDiversityRanker.selectDiverse(
  candidates,      // Array of search results with embeddings
  queryEmbedding,  // Query vector
  {
    k: 10,         // Number of results
    lambda: 0.5,   // 0=max diversity, 1=max relevance
    metric: 'cosine'
  }
);
```

### 2. Context Synthesis

Get intelligent summaries and recommendations:

```bash
# Basic query
agentdb query --query "authentication" --k 10

# With context synthesis
agentdb query --query "authentication" --k 10 --synthesize-context
```

**Output**:
```
Based on 10 similar past experiences with a high success rate of 80%
and average reward of 0.85. Common effective approaches include:
1) use oauth2 for authentication, 2) implement jwt tokens

Common Patterns:
  • use oauth2 for authentication (7/10 times)
  • implement jwt tokens (5/10 times)

Key Insights:
  • High success rate (80%) indicates strong pattern match
  • 3 exemplary solution(s) found with reward ≥0.9

Recommendations:
  1. Apply strategies from high-reward solutions
  2. Follow common patterns: use oauth2 for authentication
  3. Previous approaches were effective - follow similar methodology
```

**JavaScript API**:
```typescript
import { ContextSynthesizer } from 'agentdb/controllers';

const context = ContextSynthesizer.synthesize(memories, {
  minPatternFrequency: 2,        // Min occurrences for patterns
  includeRecommendations: true,  // Generate recommendations
  maxSummaryLength: 500          // Summary character limit
});

console.log(context.summary);
console.log(context.patterns);
console.log(context.keyInsights);
console.log(context.recommendations);
```

### 3. Metadata Filtering

Filter results with powerful MongoDB-style queries:

```bash
# Filter by success and high reward
agentdb query --query "bug-fix" \
  --filters '{"success":true,"reward":{"$gte":0.8}}'

# Filter by metadata fields
agentdb reflexion retrieve "authentication" \
  --filters '{"metadata.year":{"$gte":2024},"metadata.priority":"high"}'

# Complex filters
agentdb query --query "optimize" \
  --filters '{"success":true,"reward":{"$gt":0.75},"metadata.team":{"$in":["backend","devops"]}}'
```

**Supported Operators**:
- `$eq` - Equal to
- `$ne` - Not equal to
- `$gt` / `$gte` - Greater than (or equal)
- `$lt` / `$lte` - Less than (or equal)
- `$in` / `$nin` - In/not in array
- `$contains` - String/array contains
- `$exists` - Field exists

**JavaScript API**:
```typescript
import { MetadataFilter } from 'agentdb/controllers';

const filtered = MetadataFilter.apply(results, {
  'metadata.year': { $gte: 2024 },
  'reward': { $gt: 0.8 },
  'success': true,
  'tags': { $contains: 'production' }
});

// Validate filters before use
const validation = MetadataFilter.validate(filters);
if (!validation.valid) {
  console.error(validation.errors);
}
```

### 4. Compression Support

Efficiently export and import large databases:

```bash
# Export with compression
agentdb export ./agentdb.db --compress
# Output: agentdb-export.json.gz (60-80% smaller)

# Import compressed file (auto-detected)
agentdb import ./backup.json.gz ./new-db.db

# Custom output path
agentdb export ./agentdb.db --compress --output backups/2024-01-15.json.gz
```

**Compression Stats**:
```
✅ Exported 1000 episodes to backup.json.gz
ℹ Original size: 2.45 MB
ℹ Compressed size: 0.52 MB (78.8% reduction)
```

## Combining Features

The real power comes from combining multiple features:

```bash
# Ultimate query: filters + synthesis + diversity
agentdb query \
  --query "database optimization" \
  --k 20 \
  --filters '{"success":true,"reward":{"$gte":0.85},"metadata.database":"postgresql"}' \
  --synthesize-context

# Reflexion with full features
agentdb reflexion retrieve "authentication" \
  --k 15 \
  --min-reward 0.7 \
  --only-successes \
  --filters '{"metadata.team":"security"}' \
  --synthesize-context
```

## TypeScript Integration

```typescript
import {
  MMRDiversityRanker,
  ContextSynthesizer,
  MetadataFilter,
  type MMRCandidate,
  type SynthesizedContext,
  type MetadataFilters
} from 'agentdb/controllers';

// Complete workflow
async function intelligentSearch(
  query: string,
  memories: any[]
): Promise<SynthesizedContext> {

  // 1. Apply metadata filters
  const filtered = MetadataFilter.apply(memories, {
    'success': true,
    'reward': { $gte: 0.7 }
  });

  // 2. Select diverse results
  const diverse = MMRDiversityRanker.selectDiverse(
    filtered,
    queryEmbedding,
    { k: 10, lambda: 0.5 }
  );

  // 3. Synthesize context
  const context = ContextSynthesizer.synthesize(diverse, {
    minPatternFrequency: 2,
    includeRecommendations: true
  });

  return context;
}
```

## Best Practices

### 1. MMR Lambda Selection
- **λ = 0.3-0.4**: Use for brainstorming, exploring alternatives
- **λ = 0.5**: Balanced (recommended default)
- **λ = 0.7-0.8**: Use when relevance is critical
- **λ = 0.9-1.0**: Essentially disables diversity (standard ranking)

### 2. Context Synthesis
- Use with **k ≥ 5** for meaningful patterns
- Set `minPatternFrequency` based on result count:
  - k < 10: use 2
  - k 10-50: use 3-4
  - k > 50: use 5+

### 3. Metadata Filtering
- **Index frequently queried metadata fields**
- Use `$exists` to find incomplete data
- Combine with `--synthesize-context` for filtered insights
- Validate complex filters before production use

### 4. Compression
- Always compress exports > 1MB
- Typical compression ratios:
  - Text-heavy episodes: 75-85% reduction
  - With embeddings: 60-70% reduction
- Auto-detection handles `.gz` files seamlessly

## Performance Tips

1. **MMR Ranking**: Fetches 10× candidates for diversity
   - Keep k ≤ 100 for best performance
   - Use higher lambda (0.7-0.8) if speed critical

2. **Context Synthesis**: O(n) complexity
   - Patterns limited to top 10 automatically
   - Scales well to thousands of memories

3. **Metadata Filtering**: Filter early, synthesize late
   ```typescript
   // Good: Filter then synthesize
   const filtered = MetadataFilter.apply(results, filters);
   const context = ContextSynthesizer.synthesize(filtered);

   // Less efficient: Synthesize then filter
   const context = ContextSynthesizer.synthesize(results);
   const filtered = MetadataFilter.apply(results, filters);
   ```

## Common Use Cases

### Case 1: Find Similar But Diverse Solutions
```bash
# Problem: Standard search returns 10 nearly identical results
# Solution: Use MMR with low lambda
agentdb vector-search db.db "[0.1,0.2,0.3]" -k 10 --mmr 0.3
```

### Case 2: Understand Past Failures
```bash
# Get insights from failed attempts
agentdb reflexion retrieve "database migration" \
  --only-failures \
  --synthesize-context \
  --min-reward 0.5
```

### Case 3: Team-Specific Patterns
```bash
# Find patterns for specific team
agentdb query --query "deployment" \
  --filters '{"metadata.team":"devops","success":true}' \
  --synthesize-context
```

### Case 4: Backup Large Databases
```bash
# Daily compressed backup
agentdb export ./prod.db \
  --compress \
  --output "backups/prod-$(date +%Y%m%d).json.gz"
```

## Troubleshooting

### Issue: Filter syntax errors
```bash
# Wrong (missing quotes)
--filters {success:true}

# Correct
--filters '{"success":true}'
```

### Issue: MMR not diversifying enough
```bash
# Lower lambda value (more diversity)
--mmr 0.3  # instead of 0.5
```

### Issue: Context synthesis returns no patterns
```bash
# Need more results
--k 10  # instead of --k 3

# Lower pattern frequency threshold
# Use JavaScript API with minPatternFrequency: 1
```

### Issue: Import fails on compressed file
```bash
# Ensure .gz extension or use explicit flag
agentdb import backup.json.gz  # Auto-detected
# or
agentdb import backup.json --decompress  # Explicit
```

## Migration from v1.5.x

All v1.5.x commands work unchanged in v1.6.0:

```bash
# v1.5.x commands (still work)
agentdb reflexion retrieve "task" 10 0.8

# v1.6.0 equivalent with new features
agentdb reflexion retrieve "task" \
  --k 10 \
  --min-reward 0.8 \
  --synthesize-context
```

## Additional Resources

- **Full Documentation**: See `/docs/V1.6.0_IMPLEMENTATION_SUMMARY.md`
- **Controller APIs**: See `/src/controllers/` source files
- **Examples**: See `/examples/` directory (coming soon)

## Support

For issues or questions:
- GitHub Issues: https://github.com/ruvnet/agentic-flow/issues
- Documentation: https://agentdb.ruv.io
