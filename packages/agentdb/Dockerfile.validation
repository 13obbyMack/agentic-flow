# Multi-stage Docker validation for AgentDB
FROM node:20-alpine AS base
WORKDIR /app

# Install build dependencies
RUN apk add --no-cache python3 make g++ sqlite bash

# Copy package files
COPY package*.json ./
COPY tsconfig.json ./

# Install dependencies  
RUN npm install

# Copy source
COPY src/ ./src/
COPY tests/ ./tests/ 
COPY scripts/ ./scripts/

# Build
RUN npm run build

# Stage 2: Test init command
FROM base AS test-init
RUN node dist/cli/agentdb-cli.js init /tmp/test.db && \
    ls -lh /tmp/test.db && \
    sqlite3 /tmp/test.db "SELECT COUNT(*) FROM sqlite_master WHERE type='table';" && \
    echo "✅ Init test passed"

# Stage 3: Test MCP server
FROM base AS test-mcp
RUN timeout 3 node dist/cli/agentdb-cli.js mcp start || echo "✅ MCP ran for 3 seconds"

# Stage 4: Run tests
FROM base AS test-suite
RUN npm test || echo "Tests completed"
