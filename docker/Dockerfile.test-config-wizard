FROM node:22-slim
WORKDIR /app

# Copy local built package
COPY agentic-flow/package.json ./
COPY agentic-flow/dist ./dist
COPY agentic-flow/.claude ./.claude

# Install dependencies and link globally
RUN npm install --omit=dev && npm link

ENV NODE_ENV=production

# Test script that validates all config commands
CMD ["sh", "-c", "\
echo 'üß™ Testing Config Wizard...' && echo '' && \
\
echo '1Ô∏è‚É£ Testing config help...' && \
agentic-flow config help && \
echo '‚úÖ Help works' && echo '' && \
\
echo '2Ô∏è‚É£ Testing config list (should be empty/defaults)...' && \
agentic-flow config list && \
echo '‚úÖ List works' && echo '' && \
\
echo '3Ô∏è‚É£ Testing config set PROVIDER...' && \
agentic-flow config set PROVIDER openrouter && \
echo '‚úÖ Set works' && echo '' && \
\
echo '4Ô∏è‚É£ Testing config get PROVIDER...' && \
agentic-flow config get PROVIDER | grep -q openrouter && \
echo '‚úÖ Get works' && echo '' && \
\
echo '5Ô∏è‚É£ Testing config set API key...' && \
agentic-flow config set OPENROUTER_API_KEY sk-or-v1-test123 && \
echo '‚úÖ API key set' && echo '' && \
\
echo '6Ô∏è‚É£ Verifying .env file created...' && \
test -f .env && echo '‚úÖ .env file exists' && \
cat .env && echo '' && \
\
echo '7Ô∏è‚É£ Testing config delete...' && \
agentic-flow config delete PROVIDER && \
echo '‚úÖ Delete works' && echo '' && \
\
echo '8Ô∏è‚É£ Testing config reset...' && \
agentic-flow config reset && \
echo '‚úÖ Reset works' && echo '' && \
\
echo '‚úÖ All config wizard tests passed!' \
"]
