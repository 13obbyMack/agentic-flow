FROM node:22-slim
WORKDIR /app

# Copy local built package
COPY agentic-flow/package.json ./
COPY agentic-flow/dist ./dist
COPY agentic-flow/.claude ./.claude

# Install dependencies and link globally
RUN npm install --omit=dev && npm link

ENV NODE_ENV=production

# Test MCP server tools
CMD ["sh", "-c", "\
echo '🧪 Testing Agentic-Flow MCP Tools...' && echo '' && \
\
echo '1️⃣ Installing agentic-flow@latest globally for npx access...' && \
npm install -g agentic-flow@latest && \
echo '✅ Package installed' && echo '' && \
\
echo '2️⃣ Testing direct CLI commands...' && \
agentic-flow --list 2>&1 | grep -q 'coder' && \
echo '✅ CLI --list works' && echo '' && \
\
echo '3️⃣ Testing npx execution (what MCP server uses)...' && \
npx --yes agentic-flow --list 2>&1 | grep -q 'coder' && \
echo '✅ npx --yes agentic-flow --list works' && echo '' && \
\
echo '4️⃣ Simulating MCP tool: agentic_flow_list_agents...' && \
node -e \"const { execSync } = require('child_process'); \
const result = execSync('npx --yes agentic-flow --list', { encoding: 'utf-8', maxBuffer: 5 * 1024 * 1024, timeout: 30000 }); \
console.log(JSON.stringify({ success: true, agents: result.trim() }, null, 2));\" && \
echo '✅ MCP tool simulation works' && echo '' && \
\
echo '5️⃣ Verifying package structure...' && \
test -f dist/mcp/standalone-stdio.js && echo '✅ MCP server file exists' && \
test -f dist/cli-proxy.js && echo '✅ CLI proxy exists' && \
test -d .claude/agents && echo '✅ Agents directory exists' && \
echo '' && \
\
echo '═══════════════════════════════════════' && \
echo '  MCP Tools Validation Summary' && \
echo '═══════════════════════════════════════' && \
echo '✅ agentic_flow_list_agents: Ready' && \
echo '✅ agentic_flow_agent: Ready (executes via npx)' && \
echo '✅ Package structure: Complete' && \
echo '✅ npx execution: Verified' && \
echo '' && \
echo '🎉 MCP server is ready for use!' \
"]
